---
title: "Simulation Results: training: 3 studies; testing: 1 study"
author: "Ning Leng"
date: '`r Sys.Date()`'
output: 
  html_document:
    toc: true
    number_sections: true
    fig_width: 12
    fig_height: 7
    code_folding: hide
geometry: margin=2cm
sansfont: Calibri Light
---

Trial 1 - 3: training (200 patients each)

Trial 4: testing (800 patients)

a.0 causal

bootstrap correction and 
leave one study out CV implemented(loo.cv)

# Simulation structure
```{r, include=F, echo=F}
library(pensim)
library(tidyverse)
library(knitr)
library(glmnet)
library(pheatmap)
library(knitr)
source("util.R")
set.seed(10)

section.names <- c("No shift, same cor, same coef", "No shift, different cor, same coef", "No shift, same cor, diff coef", "With shift, same cor, same coef")
load("simudata_multistudies.rda")


```





```{r, message=FALSE, warning=FALSE, results="asis"}
for(i in 1:4){
  cat(paste0("## Heatmap: Simu ", i, ":", section.names[i],"\n\n\n"))
  simutmp <- get(paste0("simu.",i))
  heat.fun(simutmp[[1]])
  #print(summary.cor(simutmp[[1]]))
}
```




# Analysis, all x observed



```{r, message=FALSE, warning=FALSE, results="asis"}
for(i in 1:4){
  cat(paste0("## Simu ", i, ":", section.names[i],"\n\n\n"))
  for(obs.subset in c(TRUE)){
    suffix <- ifelse(obs.subset,"","noa0")
    simuname.out <- paste0("simu_multistudies.",i, suffix)
    cat(paste0("Causal feacture observed? ", obs.subset, '\n\n\n'))

    cat("### Top selected features \n\n\n")
    res.v <- readRDS(paste0(simuname.out, ".res.v.rds"))
    lasso.top <- sapply(res.v, function(i)i$lasso.top.names[1])
    print(table(lasso.top))
    cat("\n\n\n")

    uni.top <- sapply(res.v, function(i)i$uni.top.names[1])
    print(table(uni.top))
    cat("\n\n\n")
    cat("### MSE \n\n\n")
    mse.plot.df <- readRDS(paste0(simuname.out,".mse.plot.df.rds"))
    mse.tab <- mse.plot.df %>% group_by(model, method) %>% summarise(mean=mean(mse), median=median(mse))
    print(kable(mse.tab))
    cat("\n\n\n")

  }
}


```


# Analysis, a.0 (causal) not observed



```{r, message=FALSE, warning=FALSE, results="asis"}
for(i in 1:4){
  cat(paste0("## Simu ", i, ":", section.names[i],"\n\n\n"))
  for(obs.subset in c(FALSE)){
    suffix <- ifelse(obs.subset,"","noa0")
    simuname.out <- paste0("simu_multistudies.",i, suffix)
    cat(paste0("Causal feacture observed? ", obs.subset, '\n\n\n'))

    cat("### Top selected features \n\n\n")
    res.v <- readRDS(paste0(simuname.out, ".res.v.rds"))
    lasso.top <- sapply(res.v, function(i)i$lasso.top.names[1])
    print(table(lasso.top))
    cat("\n\n\n")
    uni.top <- sapply(res.v, function(i)i$uni.top.names[1])
    print(table(uni.top))
    cat("\n\n\n")
    cat("### MSE \n\n\n")
    mse.plot.df <- readRDS(paste0(simuname.out,".mse.plot.df.rds"))
    mse.tab <- mse.plot.df %>% group_by(model, method) %>% summarise(mean=mean(mse), median=median(mse))
    print(kable(mse.tab))
        cat("\n\n\n")

  }
}


```
